<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KeyWord热度 + 气温 + 湿度 + 搜索 + 排序 + 重试</title>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js" defer></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.2.1" defer></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
      overflow-x: hidden; 
    }
    .sidebar-toggle {
      position: fixed; left: 0; top: 0;
      background: #3b5998; color: #fff;
      padding: 8px 12px; border: none; cursor: pointer;
      z-index: 9999;
    }
    .sidebar {
      position: fixed; left: 0; top: 0;
      width: 280px; height: 100vh;
      background: #fafafa;
      box-shadow: 2px 0 5px rgba(0,0,0,0.2);
      transform: translateX(-100%);
      transition: transform 0.3s;
      padding: 10px;
      box-sizing: border-box;
      overflow-y: auto;
      z-index: 9998;
      padding-top: 50px;
    }
    .sidebar.active {
      transform: translateX(0);
    }
    .sidebar-close-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 20px;
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      color: #888;
    }
    .sidebar-close-btn:hover {
      color: #000;
    }
    .sidebar h3 {
      margin: 0 0 6px 0;
      display: flex; align-items: center; gap: 4px;
    }
    
    /* 优化 (UX): 新增环境数据面板样式 */
    .env-panel {
      margin-bottom: 15px;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 5px;
      background: #fff;
    }
    .env-panel label {
      margin-left: 5px; /* 覆盖默认的 label margin */
    }

    .search-row {
      display: flex; align-items: center; gap: 4px;
      margin-bottom: 8px;
    }
    .search-row input {
      flex: 1; padding: 4px 6px; font-size: 14px;
    }
    .search-row button {
      font-size: 12px; cursor: pointer; padding: 4px 8px;
    }
    .group-panel {
      margin-bottom: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    summary {
      background: #eee; padding: 4px 6px; font-weight: bold; cursor: pointer;
      display: flex; align-items: center; justify-content: space-between;
    }
    summary button {
      font-size: 12px; cursor: pointer; margin-left: 8px;
    }
    label {
      display: block;
      margin-left: 10px;
    }
    #noMatchMsg {
      display: none; color: #999; margin-top: 8px;
    }
    .main-area {
      margin-left: 60px;
      display: flex; flex-direction: column;
      height: 100vh;
      transition: margin-left 0.3s;
    }
    .main-area.sidebar-open {
      margin-left: 280px;
    }
    .topbar {
      background: #f0f0f0; padding: 8px;
      display: flex; align-items: center; gap: 6px;
      flex-shrink: 0;
    }
    .topbar h1 {
      margin: 0; 
      flex: 1;
      font-size: 1.2em;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .chart-container {
      flex: 1; position: relative; overflow: auto;
    }
    #loadingIndicator {
      display: none;
      position: absolute;
      top: 50px;
      left: 0;
      right: 0;
      text-align: center;
      font-size: 1.5em;
      color: #888;
      z-index: 10;
    }
    #myChart {
      min-width: 1200px;
      min-height: 600px;
    }
  </style>
</head>

<body>
  <button class="sidebar-toggle" id="toggleSidebar">≡</button>

  <div class="sidebar" id="sidebar">
    <button id="closeSidebar" class="sidebar-close-btn">×</button>

    <h3>环境数据</h3>
    <div id="envDataContainer" class="env-panel">
      <label>
        <input type="checkbox" data-env="avgTemp" checked>
        平均气温
      </label>
      <label>
        <input type="checkbox" data-env="maxTemp" checked>
        最高气温
      </label>
      </div>
    
    <h3>
      分组
      <button id="globalAllBtn">全选</button>
      <button id="globalNoneBtn">全不选</button>
    </h3>
    <div class="search-row">
      <input type="text" id="searchInput" placeholder="搜索分组或关键词...">
      <button id="btnClearSearch">X</button>
    </div>
    <div id="groupContainer"></div>
    <div id="noMatchMsg">未找到匹配项</div>
  </div>

  <div class="main-area" id="mainArea">
    <div class="topbar">
      <h1>KeyWord热度 + 气温 + 湿度 + 搜索 + 排序 + 重试</h1>
      <button id="btnRefresh">刷新数据</button>
      <label>开始周:</label>
      <select id="startWeek"></select>
      <label>结束周:</label>
      <select id="endWeek"></select>
      <button id="btnFilter">更新区间</button>
    </div>
    <div class="chart-container">
      <div id="loadingIndicator">
        <h2>正在加载数据，请稍候...</h2>
      </div>
      <canvas id="myChart"></canvas>
    </div>
  </div>

<script>
    /***************************************************************
     * 1) CSV链接
     ***************************************************************/
    const KEYWORD_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTxT7pk3XLnPr87Fpq2Fii90bqh_R2jsCjO6e3dZkMLKmuw75ksYiuSce3DC7uUK5IXBEFmeKT1P7oJ/pub?output=csv";
    const AVG_TEMP_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQsIu0jYheUb5YE9-D0SwtL6FxkTjFwEgWaH56NdOyqYfNkcZLJGM2xp9T2wPLcF5lYFBZ3UCa7eiaj/pub?output=csv";
    const MAX_TEMP_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSnxZTyYhuMkeM0D0ystDYz2w0tQJZDN5yyxoy51Rl8yA23j-7nSm3gOC4SeAJnhB9_iHT_mTIVzZlR/pub?output=csv";
    // 新增: 湿度 CSV
    const HUMIDITY_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRK9sDUtGwwoXVOcrB3oB3-EmGl2_M1M1kGRoZlLDU2GEzmVhY2ZvF54uTqFtu204PJ6yI95w-GpXSo/pub?gid=1893854525&single=true&output=csv";

    /***************************************************************
     * 2) 全局变量
     ***************************************************************/
    let chart;
    let labelsAll = [];
    let groupsData = {};     // 当前显示的分组/关键词数据
    let globalGroupsRaw = {}; // 原始分组数据，用于搜索还原
    let tempAvgData = [];
    let tempMaxData = [];
    // 新增: 湿度数据
    let humidityData = {}; // 格式: { "Tokyo": [...], "Osaka": [...] }

    /***************************************************************
     * 重试机制：前端拉取 CSV (最多尝试3次)
     ***************************************************************/
    function parseCSVWithRetry(url, maxAttempts = 3) {
      return new Promise((resolve, reject) => {
        let attempts = 0;
        function attemptFetch() {
          attempts++;
          Papa.parse(url, {
            download: true,
            complete: res => resolve(res),
            error: err => {
              console.warn(`[WARN] 第${attempts}次请求失败:`, err);
              if (attempts < maxAttempts) {
                attemptFetch();
              } else {
                reject(err);
              }
            }
          });
        }
        attemptFetch();
      });
    }

    /***************************************************************
     * A. 加载&解析 关键词 CSV
     ***************************************************************/
    function convertWideToLong(raw2D) {
      const rowGroup = raw2D[0];
      const rowKeyword = raw2D[1];
      const out = [];
      for (let r = 2; r < raw2D.length; r++) {
        const row = raw2D[r];
        if (!row[0]) continue;
        const fileName = row[0];
        for (let c = 1; c < row.length; c++) {
          const grp = rowGroup[c];
          const kw = rowKeyword[c];
          const val = parseFloat(row[c] || 0);
          out.push({ week_label: fileName, group: grp, keyword: kw, value: val });
        }
      }
      return out;
    }
    function processLongRows(longData) {
      const setWeeks = new Set();
      longData.forEach(it => setWeeks.add(it.week_label));
      const weeks = Array.from(setWeeks).sort();

      const gData = {};
      const count = weeks.length;
      longData.forEach(it => {
        const w = it.week_label;
        const g = it.group;
        const k = it.keyword;
        const v = it.value;
        if (!gData[g]) gData[g] = {};
        if (!gData[g][k]) gData[g][k] = new Array(count).fill(NaN);
        const idx = weeks.indexOf(w);
        gData[g][k][idx] = v;
      });

      const sorted = {};
      Object.keys(gData).sort().forEach(gName => {
        const kwMap = gData[gName];
        const sortedKwMap = {};
        Object.keys(kwMap).sort().forEach(kName => {
          sortedKwMap[kName] = kwMap[kName];
        });
        sorted[gName] = sortedKwMap;
      });
      return { weeks, groups: sorted };
    }

    /***************************************************************
     * B. 加载&解析 气温 CSV (单列)
     ***************************************************************/
    function convertTempData(raw2D) {
      const map = {};
      for (let r = 1; r < raw2D.length; r++) {
        const row = raw2D[r];
        if (!row[0]) continue;
        const wk = row[0];
        const val = parseFloat(row[1] || 0);
        map[wk] = val;
      }
      return map;
    }

    /***************************************************************
     * B2. 新增: 加载&解析 湿度 CSV (多列)
     ***************************************************************/
    function processHumidityData(raw2D) {
      const headers = raw2D[0];
      const humidityMap = {}; // 格式: { "Tokyo": {"week_label": 68.43, ...}, ... }
      const cityNames = [];

      // 从第1列开始是城市名
      for (let c = 1; c < headers.length; c++) {
        const cityName = headers[c];
        cityNames.push(cityName);
        humidityMap[cityName] = {};
      }

      // 从第1行开始是数据
      for (let r = 1; r < raw2D.length; r++) {
        const row = raw2D[r];
        if (!row[0]) continue;
        const wk = row[0]; // 第0列是 week_label
        
        for (let c = 1; c < headers.length; c++) {
          const cityName = headers[c];
          const val = parseFloat(row[c] || NaN); // 转为数字，无效值为 NaN
          humidityMap[cityName][wk] = val;
        }
      }
      return { cityNames, humidityMap };
    }

    /***************************************************************
     * C. createChart(): 唯一的图表创建/更新函数
     ***************************************************************/
    function createChart(weeks, dsList) {
      const ctx = document.getElementById("myChart").getContext("2d");
      if (chart) chart.destroy();

      chart = new Chart(ctx, {
        type: "line",
        data: { labels: weeks, datasets: dsList },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { mode: 'index', intersect: false },
          scales: {
            x: { title: { display: true, text: "周" } },
            y: { // 关键词 Y轴 (左)
              reverse: true,
              title: { display: true, text: "关键词热度(数值小→上)" }
            },
            y2: { // 气温 Y轴 (右)
              type: "linear",
              position: "right",
              reverse: false,
              title: { display: true, text: "气温(℃)" },
              grid: { drawOnChartArea: false } // 不绘制网格线，避免混乱
            },
            y3: { // 新增: 湿度 Y轴 (右)
              type: "linear",
              position: "right",
              reverse: false,
              title: { display: true, text: "湿度(%)" },
              grid: { drawOnChartArea: false }, // 不绘制网格线
              min: 0,
              max: 100
            }
          },
          plugins: {
            legend: { labels: { font: { size: 16 } } },
            tooltip: {
              titleFont: { size: 16 },
              bodyFont: { size: 16 },
              callbacks: {
                label: function (context) {
                  const val = context.parsed.y;
                  let str = context.dataset.label + ": " + val.toFixed(2);
                  if (context.dataset.yAxisID === "y2") {
                    str += "°C";
                  }
                  // 新增: 湿度单位
                  if (context.dataset.yAxisID === "y3") {
                    str += "%";
                  }
                  
                  const yoyIdx = context.dataIndex - 52;
                  if (yoyIdx >= 0) {
                    const yoyVal = context.dataset.data[yoyIdx];
                    if (yoyVal != null && !isNaN(yoyVal)) {
                      let yoyStr = " (去年: " + yoyVal.toFixed(2);
                      if (context.dataset.yAxisID === "y2") yoyStr += "°C";
                      if (context.dataset.yAxisID === "y3") yoyStr += "%";
                      yoyStr += ")";
                      str += yoyStr;
                    }
                  }
                  return str;
                }
              }
            }
          }
        }
      });
    }

    /***************************************************************
     * D. 渲染侧边栏 - 关键词部分
     ***************************************************************/
    function getLatestValue(arr) {
      if (arr.length === 0) return NaN;
      return arr[arr.length - 1];
    }

    function renderGroupSidebar(gData) {
      const container = document.getElementById("groupContainer");
      const noMatchMsg = document.getElementById("noMatchMsg");
      container.innerHTML = "";
      noMatchMsg.style.display = "none";

      let totalGroups = 0;
      Object.keys(gData).forEach(grp => {
        totalGroups++;
        const details = document.createElement("details");
        details.className = "group-panel";
        const summary = document.createElement("summary");
        summary.textContent = grp;

        const allBtn = document.createElement("button");
        allBtn.textContent = "全选";
        allBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          setGroupCheck(grp, true);
        });
        summary.appendChild(allBtn);

        const noneBtn = document.createElement("button");
        noneBtn.textContent = "全不选";
        noneBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          setGroupCheck(grp, false);
        });
        summary.appendChild(noneBtn);
        details.appendChild(summary);

        const kwMap = gData[grp];
        let kwArray = Object.keys(kwMap).map(kw => {
          const arr = kwMap[kw];
          const latestVal = getLatestValue(arr);
          return { kw, latestVal, arr };
        });
        kwArray.sort((a, b) => {
          const A = a.latestVal, B = b.latestVal;
          const isANaN = isNaN(A), isBNaN = isNaN(B);
          if (isANaN && isBNaN) return a.kw.localeCompare(b.kw);
          if (isANaN) return 1;
          if (isBNaN) return -1;
          return A - B;
        });

        kwArray.forEach(obj => {
          const lb = document.createElement("label");
          const cb = document.createElement("input");
          cb.type = "checkbox";
          cb.checked = true;
          cb.dataset.group = grp;
          cb.dataset.keyword = obj.kw;
          let lastStr = "";
          if (!isNaN(obj.latestVal)) {
            lastStr = " (" + obj.latestVal.toFixed(1) + ")";
          }
          lb.appendChild(cb);
          lb.append(" " + obj.kw + lastStr);
          details.appendChild(lb);
        });

        container.appendChild(details);
      });

      if (totalGroups === 0) {
        noMatchMsg.style.display = "";
      }

      // 重构: 监听器现在调用 updateChartDisplay
      container.addEventListener("change", (e) => {
        if (e.target.type === "checkbox") updateChartDisplay();
      });
    }

    /***************************************************************
     * D2. 搜索：过滤不匹配的分组/关键词
     ***************************************************************/
    function applySearchFilter(term) {
      const noMatchMsg = document.getElementById("noMatchMsg");
      noMatchMsg.style.display = "none";
      const s = term.trim().toLowerCase();
      let visibleCount = 0;
      const groupPanels = document.querySelectorAll(".group-panel");

      groupPanels.forEach(panel => {
        const summary = panel.querySelector("summary");
        if (!summary) return;
        const grpName = summary.childNodes[0].textContent;
        const grpLower = grpName.toLowerCase();
        const labels = panel.querySelectorAll("label");
        let groupMatched = s.length > 0 && grpLower.includes(s);
        let matchedKw = 0;

        labels.forEach(lb => {
          const txt = lb.textContent.toLowerCase();
          if (s.length === 0 || groupMatched || txt.includes(s)) {
            lb.style.display = "";
            matchedKw++;
          } else {
            lb.style.display = "none";
          }
        });

        if (s.length === 0) {
          panel.style.display = "";
          visibleCount++;
        } else {
          if (groupMatched || matchedKw > 0) {
            panel.style.display = "";
            visibleCount++;
          } else {
            panel.style.display = "none";
          }
        }
      });

      if (visibleCount === 0) {
        noMatchMsg.style.display = "";
      }
    }

    /***************************************************************
     * E. 重构: updateChartDisplay()
     * (合并了原 updateVisibleLines 和 filterDataRange)
     * 这是现在唯一的图表更新函数。
     ***************************************************************/
    function updateChartDisplay() {
      // 1. 获取日期范围
      const s = parseInt(document.getElementById("startWeek").value);
      const e = parseInt(document.getElementById("endWeek").value);
      // 确保 startIdx 总是小于 endIdx
      const startIdx = isNaN(s) ? 0 : Math.min(s, e);
      const endIdx = isNaN(e) ? labelsAll.length - 1 : Math.max(s, e);

      // 2. 切片周标签
      const slicedWeeks = labelsAll.slice(startIdx, endIdx + 1);
      
      const dsList = [];
      const colorList = [
        "#e6194b", "#3cb44b", "#ffe119", "#0082c8", "#f58231", "#911eb4", "#46f0f0",
        "#f032e6", "#d2f53c", "#fabebe", "#008080", "#e6beff", "#aa6e28", "#fffac8",
        "#800000", "#aaffc3", "#808000", "#ffd8b1", "#000080", "#808080", "#000000"
      ];
      // 新增: 湿度颜色列表
      const humidityColorList = [
          "#4bc0c0", "#9966ff", "#ff9f40", "#ff6384", "#c9cbcf", "#36a2eb"
      ];

      // 3. 构建关键词数据集
      const cbs = document.querySelectorAll(`#groupContainer input[type='checkbox']:checked`);
      let keywordIdx = 0;
      cbs.forEach(cb => {
        const grp = cb.dataset.group;
        const kw = cb.dataset.keyword;
        const fullData = globalGroupsRaw[grp][kw];
        const slicedData = fullData.slice(startIdx, endIdx + 1); // 切片
        dsList.push({
          label: grp + "/" + kw,
          data: slicedData,
          borderColor: colorList[keywordIdx % colorList.length],
          fill: false,
          tension: 0.1,
          pointRadius: 2,
          pointHoverRadius: 6,
          yAxisID: "y" // 关键词轴
        });
        keywordIdx++;
      });
      
      // 4. 构建环境数据集
      // 气温
      if (document.querySelector(`input[data-env="avgTemp"]`).checked) {
        dsList.push({
          label: "平均气温",
          data: tempAvgData.slice(startIdx, endIdx + 1), // 切片
          borderColor: "rgba(0,0,255,0.7)",
          borderWidth: 2,
          borderDash: [6, 3], // 虚线
          fill: false,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 6,
          yAxisID: "y2" // 气温轴
        });
      }
      if (document.querySelector(`input[data-env="maxTemp"]`).checked) {
         dsList.push({
          label: "最高气温",
          data: tempMaxData.slice(startIdx, endIdx + 1), // 切片
          borderColor: "rgba(255,0,0,0.7)",
          borderWidth: 2,
          borderDash: [6, 3], // 虚线
          fill: false,
          tension: 0.1,
          pointRadius: 0,
          pointHoverRadius: 6,
          yAxisID: "y2" // 气温轴
        });
      }
      
      // 湿度
      const humCbs = document.querySelectorAll(`#envDataContainer input[data-env='humidity']:checked`);
      let humIdx = 0;
      humCbs.forEach(cb => {
          const city = cb.dataset.city;
          dsList.push({
              label: `${city} 湿度`,
              data: humidityData[city].slice(startIdx, endIdx + 1), // 切片
              borderColor: humidityColorList[humIdx % humidityColorList.length],
              borderWidth: 2,
              borderDash: [3, 3], // 点状虚线
              fill: false,
              tension: 0.1,
              pointRadius: 0,
              pointHoverRadius: 6,
              yAxisID: "y3" // 湿度轴
          });
          humIdx++;
      });

      // 5. 调用唯一的 createChart 函数
      createChart(slicedWeeks, dsList);
    }

    /***************************************************************
     * E2. setGroupCheck：全选/全不选某分组
     ***************************************************************/
    function setGroupCheck(groupName, isCheck) {
      const cbs = document.querySelectorAll(`#groupContainer input[data-group="${groupName}"]`);
      cbs.forEach(cb => cb.checked = isCheck);
      updateChartDisplay(); // 重构: 调用新函数
    }

    /***************************************************************
     * F. 全局 全选/全不选
     ***************************************************************/
    function setAllCheck(isCheck) {
      const cbs = document.querySelectorAll(`#groupContainer input[type='checkbox']`);
      cbs.forEach(cb => cb.checked = isCheck);
      updateChartDisplay(); // 重构: 调用新函数
    }

    /* * G. (原 G 部分已删除)
     * filterDataRange 和 createChart2 函数已被合并到
     * updateChartDisplay 和 createChart 中，不再需要。
     */

    /***************************************************************
     * H. 主流程
     ***************************************************************/
    async function main() {
      const loadingEl = document.getElementById("loadingIndicator");
      const chartEl = document.getElementById("myChart");
      if (loadingEl) loadingEl.style.display = "block";
      if (chartEl) chartEl.style.display = "none";
      if (loadingEl) loadingEl.innerHTML = '<h2>正在加载数据，请稍候...</h2>'; // 重置消息

      try {
        // 1) 加载关键词
        const keywordRaw = await parseCSVWithRetry(KEYWORD_CSV_URL, 3);
        const longData = convertWideToLong(keywordRaw.data);
        const { weeks, groups } = processLongRows(longData);
        labelsAll = weeks;
        globalGroupsRaw = groups;
        groupsData = groups;

        // 2) 加载平均气温
        const avgRaw = await parseCSVWithRetry(AVG_TEMP_CSV_URL, 3);
        const avgMap = convertTempData(avgRaw.data);

        // 3) 加载最高气温
        const maxRaw = await parseCSVWithRetry(MAX_TEMP_CSV_URL, 3);
        const maxMap = convertTempData(maxRaw.data);
        
        // 新增: 4) 加载湿度
        const humidityRaw = await parseCSVWithRetry(HUMIDITY_CSV_URL, 3);
        const { cityNames, humidityMap } = processHumidityData(humidityRaw.data);

        // 5) 对齐所有环境数据
        tempAvgData = new Array(labelsAll.length).fill(NaN);
        tempMaxData = new Array(labelsAll.length).fill(NaN);
        // 初始化全局 humidityData
        humidityData = {};
        cityNames.forEach(city => {
          humidityData[city] = new Array(labelsAll.length).fill(NaN);
        });

        labelsAll.forEach((wk, i) => {
          // 气温
          if (avgMap[wk] != null) tempAvgData[i] = avgMap[wk];
          if (maxMap[wk] != null) tempMaxData[i] = maxMap[wk];
          // 湿度
          cityNames.forEach(city => {
            if (humidityMap[city][wk] != null) {
              humidityData[city][i] = humidityMap[city][wk];
            }
          });
        });

        // 6) 渲染环境数据面板
        const envContainer = document.getElementById("envDataContainer");
        // 清理旧的（刷新时）
        envContainer.querySelectorAll(`input[data-env='humidity']`).forEach(el => el.parentElement.remove());
        cityNames.forEach(city => {
            const lb = document.createElement("label");
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.dataset.env = "humidity";
            cb.dataset.city = city;
            cb.checked = false; // 默认不勾选
            lb.appendChild(cb);
            lb.append(` ${city} 湿度`);
            envContainer.appendChild(lb);
        });

        // 7) 渲染关键词侧边栏
        renderGroupSidebar(groupsData);

        // 8) 初始化周下拉
        const startSel = document.getElementById("startWeek");
        const endSel = document.getElementById("endWeek");
        startSel.innerHTML = '';
        endSel.innerHTML = '';
        weeks.forEach((wk, i) => {
          const opt1 = document.createElement("option");
          opt1.value = i;
          opt1.text = wk.replace("_Week_", " W");
          startSel.appendChild(opt1);
          const opt2 = document.createElement("option");
          opt2.value = i;
          opt2.text = wk.replace("_Week_", " W");
          endSel.appendChild(opt2);
        });
        startSel.value = 0;
        endSel.value = weeks.length - 1;

        // 9) 默认全选 + 首次绘图
        updateChartDisplay(); // 重构: 调用新函数

      } catch (err) {
        console.error("数据加载失败:", err);
        if (loadingEl) {
          loadingEl.innerHTML = `<h2>数据加载失败，请检查网络或CSV链接后重试。</h2>`;
        }
      } finally {
        if (loadingEl && loadingEl.style.display === "block") {
           loadingEl.style.display = "none";
        }
        if (chartEl) chartEl.style.display = "block";
      }
    }

    /***************************************************************
     * K. 事件绑定
     ***************************************************************/
    document.addEventListener("DOMContentLoaded", () => {
      
      const sidebar = document.getElementById("sidebar");
      const mainArea = document.getElementById("mainArea");
      
      document.getElementById("toggleSidebar").addEventListener("click", () => {
        sidebar.classList.add("active");
        mainArea.classList.add("sidebar-open");
      });
      document.getElementById("closeSidebar").addEventListener("click", () => {
        sidebar.classList.remove("active");
        mainArea.classList.remove("sidebar-open");
      });

      // 顶部栏
      document.getElementById("btnRefresh").addEventListener("click", main);
      // 重构: "更新区间"按钮现在只触发 updateChartDisplay
      document.getElementById("btnFilter").addEventListener("click", updateChartDisplay);

      // 侧边栏
      document.getElementById("globalAllBtn").addEventListener("click", () => setAllCheck(true));
      document.getElementById("globalNoneBtn").addEventListener("click", () => setAllCheck(false));
      
      // 搜索
      document.getElementById("searchInput").addEventListener("input", (e) => {
        applySearchFilter(e.target.value);
      });
      document.getElementById("btnClearSearch").addEventListener("click", () => {
        document.getElementById("searchInput").value = "";
        applySearchFilter("");
      });
      
      // 新增: 环境数据面板的监听器
      document.getElementById("envDataContainer").addEventListener("change", (e) => {
        if (e.target.type === 'checkbox') {
          updateChartDisplay();
        }
      });
      
      // 初始加载
      main();
    });
</script>
</body>
</html>
